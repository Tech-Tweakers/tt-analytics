name: Rework Analyzer

on:
  workflow_dispatch:
    inputs:
      repo:
        description: 'RepositÃ³rio a ser analisado'
        required: true
        default: 'polaris-python-api'
      branch:
        description: 'Branch a ser analisada'
        required: true
        default: 'main'
      threshold:
        description: 'NÃºmero mÃ­nimo de alteraÃ§Ãµes para contar como retrabalho'
        required: true
        default: '3'
      start_date:
        description: 'Data inicial (YYYY-MM-DD) - Deixe em branco para analisar tudo'
        required: false
      end_date:
        description: 'Data final (YYYY-MM-DD) - Deixe em branco para analisar atÃ© hoje'
        required: false

jobs:
  analyze_rework:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout do repositÃ³rio
        uses: actions/checkout@v3

      - name: ğŸ Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: pip install requests pandas plotly kaleido

      - name: ğŸš€ Rodar anÃ¡lise de retrabalho
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          export GITHUB_TOKEN=${{ secrets.GH_PAT }}
          export OWNER="Tech-Tweakers"
          export REPO=${{ github.event.inputs.repo }}
          export THRESHOLD=${{ github.event.inputs.threshold }}
          export START_DATE=${{ github.event.inputs.start_date || '2000-01-01' }}
          export END_DATE=${{ github.event.inputs.end_date || '' }}

          echo "ğŸ“… Analisando commits de $START_DATE atÃ© $END_DATE"
          python services/rework-rate/main.py

      - name: ğŸ’¾ Salvar resultado no repositÃ³rio
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'actions@github.com'
          git add . || echo "âš ï¸ Nada para adicionar"
          git commit -m "ğŸ”„ Atualizando mÃ©tricas de retrabalho" || echo "âš ï¸ Nenhuma alteraÃ§Ã£o para commitar"
          git push || echo "âš ï¸ Nenhuma alteraÃ§Ã£o para push"
